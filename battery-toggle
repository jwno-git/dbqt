#!/bin/bash

# Get the actual user who called sudo
REAL_USER="${SUDO_USER:-$USER}"
USER_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)

TLP_CONF="/etc/tlp.conf"

# Verify TLP config exists
if [ ! -f "$TLP_CONF" ]; then
    echo "Error: TLP configuration file not found at $TLP_CONF"
    exit 1
fi

# Get current threshold, handle case where line doesn't exist
CURRENT_THRESHOLD=$(grep "^STOP_CHARGE_THRESH_BAT0=" "$TLP_CONF" 2>/dev/null | cut -d'=' -f2)

if [ -z "$CURRENT_THRESHOLD" ]; then
    echo "Error: STOP_CHARGE_THRESH_BAT0 not found in $TLP_CONF"
    exit 1
fi

if [ "$CURRENT_THRESHOLD" = "80" ]; then
    # Switch to extended battery mode (100%)
    if sed -i 's/^STOP_CHARGE_THRESH_BAT0=80/STOP_CHARGE_THRESH_BAT0=100/' "$TLP_CONF"; then
        if tlp setcharge 20 100 BATT; then
            # Send notification as the real user
            sudo -u "$REAL_USER" DISPLAY=:0 dunstify -u normal -t 2000 "Unprotected Battery"
        else
            echo "Error: Failed to apply battery settings"
            # Revert the config change
            sed -i 's/^STOP_CHARGE_THRESH_BAT0=100/STOP_CHARGE_THRESH_BAT0=80/' "$TLP_CONF"
            exit 1
        fi
    else
        echo "Error: Failed to update TLP configuration"
        exit 1
    fi
else
    # Switch to protected mode (80%)
    if sed -i 's/^STOP_CHARGE_THRESH_BAT0=100/STOP_CHARGE_THRESH_BAT0=80/' "$TLP_CONF"; then
        if tlp setcharge 20 80 BATT; then
            # Send notification as the real user
            sudo -u "$REAL_USER" DISPLAY=:0 dunstify -u normal -t 2000 "Protected Battery"
        else
            echo "Error: Failed to apply battery settings"
            # Revert the config change
            sed -i 's/^STOP_CHARGE_THRESH_BAT0=80/STOP_CHARGE_THRESH_BAT0=100/' "$TLP_CONF"
            exit 1
        fi
    else
        echo "Error: Failed to update TLP configuration"
        exit 1
    fi
fi
